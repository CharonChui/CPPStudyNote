## 动态库

什么是库?       
库是二进制文件, 是源代码文件的另一种表现形式, 是加了密的源代码;      

是一些功能相近或者是相似的函数的集合体.      
使用库有什么好处?     
- 提高代码的可重用性, 而且还可以提高程序的健壮性;
- 可以减少开发者的代码开发量, 缩短开发周期.

库制作完成后, 如何给用户使用?      
- 头文件---包含了库函数的声明
- 库文件---包含了库函数的代码实现

注意:       
库不能单独使用, 只能作为其他执行程序的一部分完成某些功能, 也就是说只能被其他程序调用才能使用.

库可分静态库(static library)和共享库(shared library)

### 静态库(static library) 
静态库可以认为是一些目标代码的集合, 是在可执行程序运行前就已经加入到执行码中, 成为执行程序的一部分. 按照习惯, 一般以.a做为文件后缀名.      
静态库的命名一般分为三个部分：     
- 前缀：lib
- 库名称：自定义即可, 如test
- 后缀：.a

所以最终的静态库的名字应该为：libtest.a

静态库的制作

下面以fun1.c , fun2.c和head.h三个文件为例讲述静态库的制作和使用, 其中head.h文件中有函数的声明,  fun1.c和fun2.c中有函数的实现.

步骤1：将c源文件生成对应的.o文件
```c
gcc -c fun1.c fun2.c
```

或者分别生成.o文件:
```c
gcc -c fun1.c -o fun1.o
gcc -c fun2.c -o fun2.o
```

步骤2：使用打包工具ar将准备好的.o文件打包为.a文件     
- 在使用ar工具是时候需要添加参数rcs
- r更新、c创建、s建立索引
- 命令：ar rcs 静态库名 .o文件
```c
ar rcs libtest1.a fun1.o fun2.o
```


#### 静态库的使用
静态库制作完成之后, 需要将.a文件和头文件一定发布给用户.     
假设测试文件为main.c, 静态库文件为libtest1.a, 头文件为head.h        
用到的参数：    
- -L：指定要连接的库的所在目录
- -l：指定链接时需要的静态库, 去掉前缀和后缀
- -I: 指定main.c文件用到的头文件head.h所在的路径
```c
gcc -o main1 main.c -L./ -ltest1 -I./   
```
#### 静态库的优缺点
优点：
 函数库最终被打包到应用程序中，实现是函数本地化，寻址方便、速度快。
（库函数调用效率==自定义函数使用效率）
- 程序在运行时与函数库再无瓜葛，移植方便。
缺点：
- 消耗系统资源较大, 每个进程使用静态库都要复制一份, 无端浪费内存。
- 静态库会给程序的更新、部署和发布带来麻烦。如果静态库libxxx.a更新了，所有使用它的应用程序都需要重新编译、发布给用户（对于玩家来说，可能是一个很小的改动，却导致整个程序重新下载）。

### 动态库(shared library) 

共享库在程序编译时并不会被连接到目标代码中, 而是在程序运行是才被载入. 不同的应用程序如果调用相同的库, 那么在内存里只需要有一份该共享库的拷贝, 规避了空间浪费问题.      

动态库在程序运行时才被载入, 也解决了静态库对程序的更新、部署和发布会带来麻烦.      
用户只需要更新动态库即可, 增量更新. 为什么需要动态库, 其实也是静态库的特点导致. 


按照习惯, 一般以”.so”做为文件后缀名. 共享库的命名一般分为三个部分：    
- 前缀：lib
- 库名称：自己定义即可, 如test
- 后缀：.so
- 所以最终的静态库的名字应该为：libtest.so
 
共享库的制作:    
1. 生成目标文件.o, 此时要加编译选项：-fPIC（fpic）    
```c
gcc -fpic -c fun1.c fun2.c
```
参数：-fpic创建与地址无关的编译程序(pic, position independent code), 目的就是为了能够在多个应用程序间共享.
2. 生成共享库, 此时要加链接器选项: -shared（指定生成动态链接库）
```c
gcc -shared fun1.o fun2.o -o libtest2.so
```

#### 共享库的特点
- 动态库把对一些库函数的链接载入推迟到程序运行的时期。
- 可以实现进程之间的资源共享。（因此动态库也称为共享库）
- 将一些程序升级变得简单。

甚至可以真正做到链接载入完全由程序员在程序代码中控制（显示调用）

##### 比较静态库和动态库的优缺点

静态库的优点:      
1. 执行速度快, 是因为静态库已经编译到可执行文件内部了
2. 移植方便, 不依赖域其他的库文件
缺点:     
1. 耗费内存, 是由于每一个静态库的可执行程序都会加载一次
2. 部署更新麻烦, 因为静态库修改以后所有的调用到这个静态库的可执行文
件都需要重新编译
 
动态库的优点:     
1. 节省内存
2. 部署升级更新方便, 只需替换动态库即可, 然后再重启服务.
缺点:     
1. 加载速度比静态库慢
2. 移植性差, 需要把所有用到的动态库都移植.

由于由静态库生成的可执行文件是把静态库加载到了其内部, 所以静态库生成的可执行文件一般会比动态库大.


### makefile

makefile文件中定义了一系列的规则来指定哪些文件需要先编译，哪些文件需要后编译，哪些文件需要重新编译，甚至基于更复杂的功能操作，因为makefile就像是一个shell脚本一样，其中也可以执行操作系统的命令。      

makefile带来的好处就是-“自动化编译"，一旦写好，只需要一个make命令，整个工程完全自动编译，极大的提高了软件开发效率。      
make是一个命令工具，是一个解释makefile中指令的命令工具，一般来说，大多数的IDE都有这个命令，比如: Visual C++d的nmake，Linux下GNU的make。 
